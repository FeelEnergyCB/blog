 <time>2016-06-22</time>
# USB-Midi Контроллер на Arduino

Помимо веб разработки моим хобби так же является сочинение электронной музыки. Очень часто бывает, что руки заняты музыкальным инструментом и проблематично включать запись или управлять различными эффектами. И выходом из таких ситуаций является midi контроллер, которым можно управлять ногами =). В этой статье я расскажу как можно сделать такой просто и недорого.

## Компоненты
Я приведу список тех материалов, которые мне пригодились для сборки:
- 1 доска ламината
- 1 прямоугольный деревянный брусок
- Кнопки
- Провода и изоляция к ним
- Arduino Uno

Реплика arduino подойдет любая, главное чтобы был с чипом **ATmega16U2** или **8u2**, но не **CH340 (CH341)**.

![](posts/images/midi/0.jpg)

Из подручных инструментов так же понадобятся ножовка, канцелярский нож, паяльник и клей (или саморезы) для сборки всей конструкции.

## Подготовка материалов
Почему был выбран именно ламинат, а не доска или лист фанеры? Очень просто, не имея в доступности шуруповерт или дрель, проблематично делать отверстия в таких твердых материалах. А так как ламинат это по сути ДВП, то и отверстия под кнопки можно вырезать обычным канцелярским ножом.

Первым шагом отмеряем и отрезаем на листе ламината 2 отрезок 50 x 20см, а так же делим деревянный брусок длинной 20см наискосок, чтобы получилось 2 треугольника для наклона платформы.
![](posts/images/midi/1.jpg)

Далее размечаем на равных расстояниях положение кнопок, учитывая отступы с двух сторон ширину наклонных брусков.
![](posts/images/midi/2.jpg)

Отмечаем необходимый диаметр отверстий под кнопки.
![](posts/images/midi/3.jpg)

Следующим шагом сверлим (или ковыряем как в моем случае) необходимые отверстия. Кнопки же советую приобретать покрепче, нежели такой вариант как на фото. Например, как в гитарных педалях эффектов.
![](posts/images/midi/4.jpg)

В данном случае я сделал 2 ряда кнопок по 5 штук в каждом.
![](posts/images/midi/5.jpg)

Ну и монтируем кнопки на своим места.

![](posts/images/midi/6.jpg)
![](posts/images/midi/7.jpg)

## Программное обеспечение

Для программирования arduino uno воспользуемся стандартной средой разработки Arduino IDE.

### Код
```
#include <MIDI.h>

MIDI_CREATE_DEFAULT_INSTANCE();
#define BTNS_COUNT 10
#define SHIFT_NOTES 36
int momentaryBtns[BTNS_COUNT] = {2, 3, 4, 5, 6, A0, A1, A2, A3, A4};
boolean momentaryState[BTNS_COUNT];

void setup() {
    for (int i = 0; i < BTNS_COUNT; i++) {
      pinMode(momentaryBtns[i], INPUT_PULLUP);
    };
    MIDI.begin(4);
}

void loop() {  
  readButtons();
  delay(20);
}

void readButtons() {
  int momentary, toggle;
  for (int i = 0; i < BTNS_COUNT; i++) {
    momentary = digitalRead(momentaryBtns[i]);
    if (momentary == 0) {
      if (momentaryState[i] != true) {
        MIDI.sendNoteOn(SHIFT_NOTES + i,127,1);
        momentaryState[i] = true;
      }
    } else {
      if (momentaryState[i] == true) {
        MIDI.sendNoteOff(SHIFT_NOTES + i,0,1);
      }
      momentaryState[i] = false;
    }
  };
}
```

После заливки кода необходимо перепрошить arduino. Из репозитория проекта [hiduino](https://github.com/ddiakopoulos/hiduino/tree/master/compiled_firmwares) нужно скачать 2 прошивки: arduino_midi.hex и usbserial_uno_16u2.hex (или usbserial_uno_8u2.hex в зависимости от чипа).

Для прошивки нужно подключить arduino к компьютеру, далее замкнуть 2 контакта (см. рисунок ниже) и в консоли выполнить следующие команды.

![](posts/images/midi/8.jpg)

```
sudo dfu-programmer atmega16u2 erase

sudo dfu-programmer atmega16u2 flash arduino_midi.hex
или
sudo dfu-programmer atmega16u2 flash usbserial_uno_16u2.hex --suppress-bootloader-mem
// для возврата к стандартной прошивке

sudo dfu-programmer atmega16u2 reset
```

## Сборка

Ну и последний этап это пайка и сборка устройства в целом. Сигналы кнопок соответствуют следующим выводам:
2, 3, 4, 5, 6 - нижний ряд.
A0, A1, A2, A3, A4 - верхний ряд.
Вторым контактом кнопки соединены между собой и идут на вывод земли arduino.
![](posts/images/midi/9.jpg)
![](posts/images/midi/10.jpg)
![](posts/images/midi/11.jpg)
Аrduino приклеиваем (или привинчиваем) к краю доски, чтобы было удобнее подключать usb кабель. Так же поступаем c наклонными брусками и нижней частью.
![](posts/images/midi/12.jpg)

## Заключение
В итоге мы получаем недорогой usb-midi контроллер на базе arduino, на кнопки которого можно замапить любой параметр, какой позволяется выбранная вами DAW.
![](posts/images/midi/13.jpg)
